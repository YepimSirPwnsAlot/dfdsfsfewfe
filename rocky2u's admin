-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- VARIABLES
local murderer = nil
local sheriff = nil
local espLine = nil
local drawing = false

-- GUI SETUP
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MM2ESPGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game:GetService("CoreGui")

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 240, 0, 160)
MainFrame.Position = UDim2.new(0.01, 0, 0.8, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.BorderSizePixel = 0
MainFrame.BackgroundTransparency = 0.1
MainFrame.Parent = ScreenGui

Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)

local UIStroke = Instance.new("UIStroke", MainFrame)
UIStroke.Color = Color3.fromRGB(255, 0, 0)
UIStroke.Thickness = 2

local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0, 220, 0, 40)
ToggleButton.Position = UDim2.new(0, 10, 0, 10)
ToggleButton.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
ToggleButton.Text = "Find Roles"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.TextSize = 16
ToggleButton.Parent = MainFrame
Instance.new("UICorner", ToggleButton).CornerRadius = UDim.new(0, 6)

local MurdererLabel = Instance.new("TextLabel")
MurdererLabel.Size = UDim2.new(0, 220, 0, 25)
MurdererLabel.Position = UDim2.new(0, 10, 0, 60)
MurdererLabel.BackgroundTransparency = 1
MurdererLabel.Text = "Murderer: None"
MurdererLabel.TextColor3 = Color3.fromRGB(255, 85, 85)
MurdererLabel.Font = Enum.Font.Gotham
MurdererLabel.TextSize = 14
MurdererLabel.TextXAlignment = Enum.TextXAlignment.Left
MurdererLabel.Parent = MainFrame

local SheriffLabel = Instance.new("TextLabel")
SheriffLabel.Size = UDim2.new(0, 220, 0, 25)
SheriffLabel.Position = UDim2.new(0, 10, 0, 90)
SheriffLabel.BackgroundTransparency = 1
SheriffLabel.Text = "Sheriff: None"
SheriffLabel.TextColor3 = Color3.fromRGB(85, 170, 255)
SheriffLabel.Font = Enum.Font.Gotham
SheriffLabel.TextSize = 14
SheriffLabel.TextXAlignment = Enum.TextXAlignment.Left
SheriffLabel.Parent = MainFrame

-- ESP FUNCTION
local function createESPLine()
    local line = Drawing.new("Line")
    line.Thickness = 2
    line.Color = Color3.fromRGB(255, 0, 0)
    line.Transparency = 1
    return line
end

-- FIND ROLES
local function findRoles()
    murderer, sheriff = nil, nil
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local tool = player.Character:FindFirstChildOfClass("Tool") or player:FindFirstChild("Backpack") and player.Backpack:FindFirstChildOfClass("Tool")
            if tool then
                if tool.Name == "Gun" then
                    sheriff = player
                else
                    murderer = player
                end
            end
        end
    end
end

-- DRAW LOOP
RunService.RenderStepped:Connect(function()
    if drawing and murderer and murderer.Character and murderer.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = murderer.Character.HumanoidRootPart
        local screenPos, onScreen = workspace.CurrentCamera:WorldToViewportPoint(hrp.Position)
        if onScreen then
            espLine.From = Vector2.new(workspace.CurrentCamera.ViewportSize.X / 2, workspace.CurrentCamera.ViewportSize.Y)
            espLine.To = Vector2.new(screenPos.X, screenPos.Y)
            espLine.Visible = true
        else
            espLine.Visible = false
        end
    elseif espLine then
        espLine.Visible = false
    end
end)

-- TOGGLE FUNCTIONALITY
ToggleButton.MouseButton1Click:Connect(function()
    if drawing then
        drawing = false
        ToggleButton.Text = "Find Roles"
        MurdererLabel.Text = "Murderer: None"
        SheriffLabel.Text = "Sheriff: None"
        if espLine then
            espLine:Remove()
            espLine = nil
        end
    else
        findRoles()
        if murderer then
            MurdererLabel.Text = "Murderer: " .. murderer.Name
            espLine = createESPLine()
            drawing = true
        else
            MurdererLabel.Text = "Murderer: Not found"
        end

        if sheriff then
            SheriffLabel.Text = "Sheriff: " .. sheriff.Name
        else
            SheriffLabel.Text = "Sheriff: Not found"
        end

        ToggleButton.Text = "Clear"
    end
end)
